#!/bin/bash

set -e # Errors are fatal
set -x # Show commands

FULL=
if [ $1 = "--full" ]
then
  FULL=1
  shift
fi

MOZSEARCH_ROOT=$(realpath $1)
INDEX_ROOT=$(realpath $2)
TREE_ROOT=$(realpath $3)

cd $TREE_ROOT
if [ ! -d mozilla-central ]
then
  hg clone http://hg.mozilla.org/mozilla-central
fi

cd mozilla-central

if [ $FULL ]
then
  hg up

  cat >.mozconfig <<EOF
. \$topsrcdir/browser/config/mozconfig
mk_add_options MOZ_OBJDIR=@TOPSRCDIR@/objdir
ac_add_options --enable-debug
ac_add_options --enable-optimize
EOF

  if [ CLOBBER -nt objdir/CLOBBER ]
  then
    rm -rf objdir
  fi

  ./mach build
fi

# FIXME: Get list of files to do JS analysis on
JS_FILES=$MOZSEARCH_ROOT/js-files
ALL_FILES=$MOZSEARCH_ROOT/all-files

if [ "x${JS}" = "x" ]
then
  JS=$(which js)
  if [ "x${JS}" = "x" ]
  then
    JS="$PWD/objdir/dist/bin/run-mozilla.sh $PWD/objdir/dist/bin/js"
  fi
fi

cd $TREE_ROOT
$CODESEARCH $MOZSEARCH_ROOT/livegrep-index.json -dump_index $INDEX_ROOT/livegrep.idx </dev/null

# Avoid using $PWD
cd /tmp

let "i = 0" || true
for filename in $(cat $JS_FILES)
do
  mkdir -p $INDEX_ROOT/analysis/$(dirname $filename)
  if [ $TREE_ROOT/mozilla-central/$filename -nt $INDEX_ROOT/analysis/$filename -o \
       $MOZSEARCH_ROOT/js-analyze.js -nt $INDEX_ROOT/analysis/$filename ]
  then
    $JS $MOZSEARCH_ROOT/js-analyze.js $i $TREE_ROOT/mozilla-central/$filename > $INDEX_ROOT/analysis/$filename
  fi
  let "i = i+1"
done

cat $JS_FILES | xargs $JS $MOZSEARCH_ROOT/crossref.js \
                          $TREE_ROOT/mozilla-central/ \
                          $INDEX_ROOT/analysis/ \
                          $INDEX_ROOT/crossref \
                          $INDEX_ROOT/jumps

ALL_DIRS=$MOZSEARCH_ROOT/all-dirs
DIRLIST=$((for f in $(cat $ALL_FILES); do echo ${f%/*}; done)|uniq)
for dir in $DIRLIST
do
  if [ -d $TREE_ROOT/mozilla-central/$dir ]
  then
    echo $dir >>$ALL_DIRS
  fi
done
echo / >>$ALL_DIRS

for dir in $(cat $ALL_DIRS)
do
  mkdir -p $INDEX_ROOT/file/$dir
  mkdir -p $INDEX_ROOT/dir/$dir
done

cat $ALL_FILES | parallel -X --eta $JS $MOZSEARCH_ROOT/output-file.js $TREE_ROOT/mozilla-central $INDEX_ROOT $MOZSEARCH_ROOT

cat $ALL_DIRS | parallel -X --eta $JS $MOZSEARCH_ROOT/output-dir.js $TREE_ROOT/mozilla-central $INDEX_ROOT $MOZSEARCH_ROOT
